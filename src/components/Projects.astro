---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import SkillBadge from "./SkillBadge.astro";
import { ExternalLink, Eye } from "@lucide/astro";

const projectEntries = await getCollection("projects");

// Sort by start date, most recent first
const sortedProjects = projectEntries.sort(
  (a, b) => b.data.startDate.getTime() - a.data.startDate.getTime(),
);

// Get the latest project
const project = sortedProjects[0];

function formatPeriod(startDate: Date, endDate?: Date) {
  const options: Intl.DateTimeFormatOptions = {
    month: "short",
    year: "numeric",
  };
  const start = startDate.toLocaleDateString("en-US", options);
  const end = endDate
    ? endDate.toLocaleDateString("en-US", options)
    : "Present";
  return `${start} - ${end}`;
}
---

<section id="projects" class="py-20 px-4">
  <div class="max-w-6xl mx-auto">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-bold mb-4">Recent Works</h2>
    </div>

    {
      project && (
        <article class="card lg:card-side bg-base-100/50 backdrop-blur-md border border-white/20 shadow-2xl overflow-hidden transition-all duration-300 hover:shadow-primary/5 hover:border-primary/20 hover:scale-[1.01] rounded-3xl">
          <div class="card-body lg:w-1/2 justify-center order-2 lg:order-1">
            <h3 class="card-title text-3xl font-bold mb-2">
              <a
                href={project.data.demoLink || `/projects/${project.id}`}
                target={project.data.demoLink ? "_blank" : "_self"}
                rel={project.data.demoLink ? "noopener noreferrer" : ""}
                class="hover:text-primary transition-colors">
                {project.data.title}
              </a>
            </h3>
            <time class="text-lg text-base-content/60 mb-2 block">
              {formatPeriod(project.data.startDate, project.data.endDate)}
            </time>
            <h4 class="text-base-content/80 mb-4 leading-relaxed">
              {project.data.description}
            </h4>

            <div class="flex flex-wrap gap-2 mb-4">
              {project.data.skills.map((skill) => (
                <SkillBadge skill={skill} />
              ))}
            </div>

            <div class="card-actions justify-start gap-4">
              {project.data.demoLink && (
                <a
                  href={project.data.demoLink}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn btn-primary gap-2 rounded-full">
                  <ExternalLink class="size-5" />
                  View Live
                </a>
              )}
              {project.data.sourceLink && (
                <a
                  href={project.data.sourceLink}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="btn btn-ghost gap-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="20"
                    viewBox="0 0 32 32"
                    fill="currentColor">
                    <path d="M16,2.345c7.735,0,14,6.265,14,14-.002,6.015-3.839,11.359-9.537,13.282-.7,.14-.963-.298-.963-.665,0-.473,.018-1.978,.018-3.85,0-1.312-.437-2.152-.945-2.59,3.115-.35,6.388-1.54,6.388-6.912,0-1.54-.543-2.783-1.435-3.762,.14-.35,.63-1.785-.14-3.71,0,0-1.173-.385-3.85,1.435-1.12-.315-2.31-.472-3.5-.472s-2.38,.157-3.5,.472c-2.677-1.802-3.85-1.435-3.85-1.435-.77,1.925-.28,3.36-.14,3.71-.892,.98-1.435,2.24-1.435,3.762,0,5.355,3.255,6.563,6.37,6.913-.403,.35-.77,.963-.893,1.872-.805,.368-2.818,.963-4.077-1.155-.263-.42-1.05-1.452-2.152-1.435-1.173,.018-.472,.665,.017,.927,.595,.332,1.277,1.575,1.435,1.978,.28,.787,1.19,2.293,4.707,1.645,0,1.173,.018,2.275,.018,2.607,0,.368-.263,.787-.963,.665-5.719-1.904-9.576-7.255-9.573-13.283,0-7.735,6.265-14,14-14Z" />
                  </svg>
                  Source Code
                </a>
              )}
            </div>
          </div>
          <figure class="lg:w-1/2 order-1 lg:order-2 m-0 p-0">
            <a
              href={project.data.demoLink || `/projects/${project.id}`}
              target={project.data.demoLink ? "_blank" : "_self"}
              rel={project.data.demoLink ? "noopener noreferrer" : ""}
              class="block h-full w-full">
              <Image
                src={project.data.image}
                alt={project.data.title}
                class="w-full h-full object-cover min-h-[250px]"
                width={800}
                height={100}
              />
            </a>
          </figure>
        </article>
      )
    }
  </div>
</section>
